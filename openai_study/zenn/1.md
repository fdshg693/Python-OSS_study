# 以下のコードの深堀り

```python
from openai import OpenAI
client = OpenAI()
```

## `OpenAI`インスタンス

- `api_key`引数からAPIキーを渡すか、環境変数`OPENAI_API_KEY`から自動的に取得します。
  - `.env`の自動取得は行いません
  - また、興味深いことに`Callable[[], str]`型の引数も受け取れます。これにより、APIキーを動的に取得することが可能です。
  - 物凄い単純な実装だと以下のよう

```python
def retrun_api_key():
    return "sk-xxxxxx"

client = OpenAI(api_key=retrun_api_key)
```

- base_urlの設定も以下のように行われます

```python
if base_url is None:
    base_url = os.environ.get("OPENAI_BASE_URL")
if base_url is None:
    base_url = f"https://api.openai.com/v1"
```

以後、そのほかの引数が与えられた場合のチェックが続いたあと、`super().__init__`で`SyncAPIClient`が初期化されます。

## `SyncAPIClient`クラス　前半

timeout設定等を行い、更に親クラスの`BaseClient`を初期化します。

## `BaseClient`クラス

`version`や`base_url`、`headers`等の引数をここでプロパティにセットします。
また、少し面白いのが、URLの正規化のみ以下のようにしてメソッドを呼び出して行っています。

```python
def _enforce_trailing_slash(self, url: URL) -> URL:
    if url.raw_path.endswith(b"/"):
        return url
    return url.copy_with(raw_path=url.raw_path + b"/")
```

このメソッドは、URLのパスがスラッシュで終わっていない場合にスラッシュを追加する役割を果たしています。
また、`url`変数が`URL`型であることから、連結する際に`b"/"`のようにバイト列で追加している点も興味深いです。

## `SyncAPIClient`クラス　後半

`BaseClient`の初期化が終わった後、`self._client`に`http_client`をセットしています。
`http_client`が`None`の場合は、新たに`httpx.Client`インスタンスを作成しています。

```python
self._client = http_client or SyncHttpxClientWrapper(
    base_url=base_url,
    # cast to a valid type because mypy doesn't understand our type narrowing
    timeout=cast(Timeout, timeout),
)
```

`SyncHttpxClientWrapper`はOPENAIライブラリ独自の型ですが、実態としてはほとんど`httpx.Client`の薄いラッパーに過ぎません。
結局`base_url`・`timeout`等の引数を渡して`httpx.Client`を初期化しています。
